<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<form action="/AliceDiary/register" method="post"
	th:object="${memberDto}" enctype="multipart/form-data">
	<div>
		프로필 사진 등록<br /> <img id="profileImage"
			style="width: 150px; height: 190px;"> <input type="file"
			th:field="*{profileImg}" id="file" onchange="PreviewImage();" /><br />
	</div>
	<div>
		<label th:for="id">아이디</label> <input type="text" th:field="*{id}"
			th:oninput="checkId();"> <span class="id_ok">사용 가능한
			아이디입니다.</span> <span class="id_already">누군가 이 아이디를 사용하고 있어요.</span>
		<p th:if="${#fields.hasErrors('id')}" th:errors="*{id}"></p>
	</div>
	<div>
		<label th:for="pwd">비밀번호</label> <input type="password"
			th:field="*{pwd}">
		<p th:if="${#fields.hasErrors('pwd')}" th:errors="*{pwd}"></p>
	</div>
	<div>
		<label th:for="confirmPassword">비밀번호 확인</label> <input type="password"
			th:field="*{confirmPassword}" th:onkeyup="checkPwd()">&nbsp;&nbsp;<span
			id="confirmMsg"></span>
		<p th:if="${#fields.hasErrors('confirmPassword')}"
			th:errors="*{confirmPassword}"></p>
	</div>
	<div>
		<label th:for="name">이름</label> <input type="text" th:field="*{name}">
		<p th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></p>
	</div>
	<div>
		<label th:for="birth">생년월일</label> <input type="date"
			th:field="*{birth}">
		<p th:if="${#fields.hasErrors('birth')}" th:errors="*{birth}"></p>
	</div>
	<div>
		<label th:for="gender">성별</label> 
		<select th:field="*{gender}">
			<option  th:value="none">===선택===</option>
		    <option th:value="'MALE'" th:text="MALE"></option>
		    <option th:value="'FEMALE'" th:text="FEMALE"></option>
		    <option th:value="'UNKNOWN'" th:text="UNKNOWN"></option>
		</select>
	</div>
	<div>
		<label th:for="mobile">전화번호</label> <input type="text"
			th:field="*{mobile}" placeholder="(-제외)">
		<p th:if="${#fields.hasErrors('mobile')}" th:errors="*{mobile}"></p>
	</div>
	<div>
		<label th:for="email">이메일</label> <input type="email"
			th:field="*{email}">
		<p th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></p>
	</div>
	<div>
		<label th:for="mbti">MBTI</label> <input type="text"
			th:field="*{mbti}">
		<p th:if="${#fields.hasErrors('mbti')}" th:errors="*{mbti}"></p>
	</div>
	<div>
		<label th:for="wishList">위시 리스트</label> <input type="text"
			th:field="*{wishList}" placeholder="(선택)">
		<p th:if="${#fields.hasErrors('wishList')}" th:errors="*{wishList}"></p>
	</div>

	<div style="text-align: center">
		<button type="submit" th:onclick="regSuccess()">가입</button>
		<button type="button" th:onclick="regCancle()">취소</button>
	</div>
	<input type="hidden" th:name="${_csrf.parameterName}"
		th:value="${_csrf.token}">
</form>


<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<link id="contextPathHolder" th:data-contextPath="${#httpServletRequest.getContextPath()}"/>

<style type="text/css">
.id_ok {
	color: #6A82FB;
	display: none;
}

.id_already {
	color: #F67360;
	display: none;
}
</style>

<script type="text/javascript">
	/* function email_auth_alert() {
		alert("이메일을 전송하였습니다.");
	} */
	
	function regSuccess() {
		alert("가입을 축하합니다!")
	}
	
	function regCancle() {
		if(!confirm("가입을 취소하시겠습니까?")) {
			return;
		}else {
			alert("가입이 취소되었습니다.");
			var contextPath = $('#contextPathHolder').attr('data-contextPath') ? $('#contextPathHolder').attr('data-contextPath') : '';
			location = contextPath + "/";
		}
	}
	
	function checkPwd() {
		var password = document.getElementById('pwd');
		var confirmPassword = document.getElementById('confirmPassword');
		var confirmMsg = document.getElementById('confirmMsg');
		var correctColor = "#00ff00";
		var wrongColor = "#ff0000";

		if (password.value == confirmPassword.value) {
			confirmMsg.innerHTML = "";
		} else {
			confirmMsg.style.color = wrongColor;
			confirmMsg.innerHTML = "비밀번호 불일치";
		}
	}

	function PreviewImage() {
		var preview = new FileReader();
		preview.onload = function(e) {
			document.getElementById("profileImage").src = e.target.result;
		};
		preview.readAsDataURL(document.getElementById("file").files[0]);
	};

	function checkId() {
		var header = $("meta[name='_csrf_header']").attr('content');
		var token = $("meta[name='_csrf']").attr('content');
		var id = document.getElementById("id").value; //id값이 "id"인 입력란의 값을 저장
		$.ajax({
			url : './register/idCheck', //컨트롤러에서 인식할 주소
			type : 'post', //POST 방식으로 전달
			data : {
				id : id
			},
			beforeSend : function(xhr) {
				xhr.setRequestHeader(header, token);
			},
			success : function(check) { //컨트롤러에서 넘어온 check값을 받는다
				if (check != 1) {
					console.log('check 값: ' + check);
					$('.id_ok').css("display", "inline-block");
					$('.id_already').css("display", "none");

				} else {
					$('.id_already').css("display", "inline-block");
					$('.id_ok').css("display", "none");
				}
			},
			error : function() {
				alert("에러가 발생했습니다.");
			}
		});
	};
</script>

</html>